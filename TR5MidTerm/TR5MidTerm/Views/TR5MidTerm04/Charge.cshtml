@model TR5MidTerm.Models.TR5MidTermViewModels.收款明細檔CreateViewModel

@if (ViewBag.無收款主檔)
{
    <div class="alert alert-warning" role="alert">
        ⚠️ 無可用的收款主檔，無法新增收款明細。
    </div>
}
else if (ViewBag.無租約明細)
{
    <div class="alert alert-warning" role="alert">
        ⚠️ 本租約的尚未加入租金商品項目。
    </div>
}
else
{

    // Razor 頁面中先計算顯示用 firstYm
    var firstYm = @Model.計租年月;

    <form asp-action="Charge" method="post">
        @Html.AntiForgeryToken()

        @* Hidden 鍵值欄位 *@
        <input type="hidden" asp-for="事業" />
        <input type="hidden" asp-for="單位" />
        <input type="hidden" asp-for="部門" />
        <input type="hidden" asp-for="分部" />
        <input type="hidden" asp-for="案號" />

        <div class="row">
            <div class="col-md-12 form-group">
                <label asp-for="案號名顯示"></label>
                <input asp-for="案號名顯示" class="form-control" readonly />
                <span asp-validation-for="案號名顯示" class="text-danger"></span>
            </div>

            <div class="col-md-3 form-group">
                <label>每期租金（含稅）</label>
                <input type="text" class="form-control" readonly value="@Model.每期租金含稅" />
            </div>

            <div class="col-md-6 form-group text-center ">
                <label>本次欲收款期數（每期 @Model.每期月數 月）</label>

                <!-- 🔹第一排：range + number input -->
                <div class="d-flex align-items-center justify-content-end gap-2">
                    <input id="range-收期數" type="range" min="1" max="@Model.可收期數上限"
                           class="form-range flex-grow-1" style="max-width: 250px;" />

                    <input id="input-收期數" type="number" min="1" max="@Model.可收期數上限"
                           class="form-control form-control-sm  mt-2" style="width: 70px;" />
                </div>

                <!-- 🔹第二排：顯示文字另起一行並置中 -->
                <div class="text-center mt-1">
                    <span id="label-收期數視覺" class="fw-bold text-dark">共收 @Model.追繳應收期數 期</span>
                </div>

                <span asp-validation-for="本次收幾期" class="text-danger"></span>

                <small class="text-center  form-text text-muted">
                    請選擇本次要收取的<strong>期數</strong>，最多為 @Model.可收期數上限 期（共 @Model.剩餘可收月數 個月）。
                </small>

                <div id="partial-month-hint" class="form-text text-warning" style="display:none;"></div>
            </div>

            <div class="col-md-3 form-group">
                <label asp-for="金額">本次欲收租金總額</label>
                <input asp-for="金額" id="input-欲收租金總額" class="form-control" readonly />
                <span asp-validation-for="金額" class="text-danger"></span>
            </div>
            <!-- ✅ 顯示用：firstYm，這只是顯示，不送出 -->
            <div class="col-md-5 form-group">
                <label>收租起始月</label>
                <input type="text" class="form-control" value="@firstYm.ToString("yyyy-MM")" readonly />
            </div>

            <div class="col-md-5 form-group">
                <label>收租結束月</label>
                @*（與起始月對稱、可視為本期的尾月 ）*@
                <input type="text" class="form-control" id="text-顯示計租年月" value="@Model.計租年月.ToString("yyyy-MM-dd")" readonly />

            </div>
            @*<div class="col-md-5 form-group">

                </div>*@


            <input asp-for="計租年月" type="hidden" />
            <input asp-for="計租年月_判斷殘月用" type="hidden" />
            <input type="hidden" id="剩餘月數" value="@Model.剩餘可收月數" />
            <input type="hidden" id="每期月數" value="@Model.每期月數" />

            <div class="col-md-12 form-group d-flex justify-content-end align-items-center gap-2">
                <button type="button" id="btn-帶入追繳期數" class="btn btn-secondary">
                    至今欠期
                </button>

                <button type="submit" class="btn btn-success ml-2">儲存收款明細</button>
            </div>

            @*<div class="col-md-12">
                    <small class="form-text text-muted text-end d-block">
                        請選擇本次要收取的<strong>期數</strong>，最多為 @Model.可收期數上限 期（共 @Model.剩餘可收月數 個月）。
                    </small>
                </div>*@
        </div>
    </form>

    <script>
$(document).ready(function () {
    const 起算年月 = new Date('@Model.計租年月.ToString("yyyy-MM-dd")');
    const 每月租金 = parseFloat('@Model.每月租金含稅');
    const 每期月數 = parseInt('@Model.每期月數');
    const 租約剩餘可收月數 = parseInt('@Model.剩餘可收月數');
    const 可收期數上限 = parseInt('@Model.可收期數上限');
    const 追繳應收期數 = parseInt('@Model.追繳應收期數');

    const $range = $('#range-收期數');
    const $input = $('#input-收期數');
    const $label = $('#label-收期數視覺');

    // 共用邏輯函式
    const 更新畫面 = function (本次收幾期) {
        const 本次收幾個月 = 本次收幾期 * 每期月數;
        const 實際收幾個月 = Math.min(本次收幾個月, 租約剩餘可收月數);
        const 完整期數 = Math.floor(實際收幾個月 / 每期月數);
        const 殘月數 = 實際收幾個月 % 每期月數;
        const totalRentThisTime = (完整期數 * 每期月數 * 每月租金) + (殘月數 * 每月租金);
        $('#input-欲收租金總額').val(totalRentThisTime.toFixed(2));

        $('input[name="計租年月"]').val(起算年月.toISOString().split('T')[0]);
        $('input[name="計租年月_判斷殘月用"]').val(起算年月.toISOString().split('T')[0]);

        let 收租結束月 = new Date(起算年月);
        收租結束月.setMonth(收租結束月.getMonth() + 本次收幾個月);

        const y = 收租結束月.getFullYear();
        const m = (收租結束月.getMonth() + 1).toString().padStart(2, '0');
        const d = 收租結束月.getDate().toString().padStart(2, '0');
        $('#text-顯示計租年月').val(`${y}-${m}-${d}`);

        const 殘期月數 = 本次收幾個月 > 租約剩餘可收月數 ? 租約剩餘可收月數 % 每期月數 : 0;
        if (殘期月數 > 0) {
            $('#partial-month-hint')
                .text(`⚠️ 最後一期為殘期：僅收 ${殘期月數} 月`)
                .show();
        } else {
            $('#partial-month-hint').hide();
        }
         
        // 🟢 顏色與文字更新（含欠繳計算）
        let prefix = '';
        let colorClass = '';
        let labelText = '';

        if (本次收幾期 < 追繳應收期數) {
            const 欠繳期數 = 追繳應收期數 - 本次收幾期;
            prefix = `還欠繳 ${欠繳期數} 期`;
            colorClass = 'text-danger';
            labelText = prefix;
        } else if (本次收幾期 === 追繳應收期數) {
            labelText = `共收 ${本次收幾期} 期`;
            colorClass = 'text-dark';
        } else {
            labelText = `超收 ${本次收幾期} 期`;
            colorClass = 'text-primary';
        }

        $label.text(labelText);
        $label.removeClass('text-danger text-dark text-primary').addClass(colorClass);

        if (本次收幾期 < 追繳應收期數) {
            $label.addClass('text-danger'); // 🔴 少收
        } else if (本次收幾期 == 追繳應收期數) {
            $label.addClass('text-dark'); // ⚫ 剛好
        } else {
            $label.addClass('text-primary'); // 🔵 超收
        }
    };

    // 雙向綁定
    $range.on('input', function () {
        const val = parseInt($(this).val());
        $input.val(val);
        更新畫面(val);
    });

    $input.on('input', function () {
        let val = parseInt($(this).val());
        if (isNaN(val)) val = 1;
        val = Math.min(Math.max(val, 1), 可收期數上限);
        $(this).val(val);
        $range.val(val);
        更新畫面(val);
    });

    $('#btn-帶入追繳期數').on('click', function () {
        $range.val(追繳應收期數).trigger('input');
    });

    // 預設觸發一次
    $range.trigger('input');
});

    </script>


}


