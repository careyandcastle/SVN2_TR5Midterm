@model TR5MidTerm.Models.TR5MidTermViewModels.租約主檔EditViewModel
<form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()  <!-- ✅ 加入防偽驗證 -->
    <div class="row">
        <div class="col-md-6">
            <!-- 案名 -->
            <div class="form-group">
                <label asp-for="案名" class="control-label"></label>
                <input asp-for="案名" class="form-control" placeholder="請輸入" />
                <span asp-validation-for="案名" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-6">
            <!-- 案名 -->
            <div class="form-group">
                <label asp-for="案號" class="control-label"></label>
                <input asp-for="案號" class="form-control" placeholder="請輸入" />
                <span asp-validation-for="案號" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-6">
            <!-- 承租人 -->
            <div class="form-group">
                <label asp-for="承租人編號" class="control-label"></label>
                <select asp-for="承租人編號" class="form-control" asp-items="ViewBag.承租人選項">
                    <option disabled selected value="">-- 請選擇 --</option>
                </select>
                <span asp-validation-for="承租人編號" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-6">
            <!-- 租賃方式 -->
            <div class="form-group">
                <label asp-for="租賃方式編號" class="control-label"></label>
                <select asp-for="租賃方式編號" class="form-control" asp-items="ViewBag.租賃方式選項">
                    <option disabled selected value="">-- 請選擇 --</option>
                </select>
                <span asp-validation-for="租賃方式編號" class="text-danger"></span>
            </div>
        </div>

        <div class="col-md-6">
            <div>
                <label class="control-label">租賃用途輸入方式</label>
            </div>
            <div class="mt-2">
                <div class="btn-group" role="group" aria-label="租賃用途輸入方式">
                    <input type="radio" class="btn-check" name="inputMode" id="mode-select" value="select" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="mode-select">清單選擇</label>

                    <input type="radio" class="btn-check" name="inputMode" id="mode-input" value="input" autocomplete="off">
                    <label class="btn btn-outline-primary" for="mode-input">手動輸入</label>
                </div>
            </div>
        </div>

        <!-- 右：租賃用途實際欄位（select/input 二選一） -->
        <div class="col-md-6">
            <!-- Select 選擇 -->
            <div class="form-group" id="租賃用途-select-div">
                <label asp-for="租賃用途" class="control-label">租賃用途</label>
                <select asp-for="租賃用途" class="form-control" asp-items="ViewBag.租賃用途選項"  >
                    @*<option disabled selected value="">-- 請選擇 --</option>*@
                </select>
                <span asp-validation-for="租賃用途" class="text-danger"></span>
            </div>

            <!-- 手動輸入 -->
            <div class="form-group" id="租賃用途-input-div" style="display:none;">
                <label asp-for="租賃用途" class="control-label">租賃用途</label>
                <input asp-for="租賃用途" class="form-control" type="text" placeholder="請輸入" />
                <span asp-validation-for="租賃用途" class="text-danger"></span>
            </div>
        </div>

        <!-- 起始日 + 月數 + 週期 -->
        <div class="col-md-4">
            <label asp-for="租約起始日期" class="form-label">起始日期</label>
            <input asp-for="租約起始日期" type="date" class="form-control form-control-sm" id="租約起始日期" />
        </div>
        <div class="col-md-4">
            <label asp-for="租期月數" class="form-label">租期月數</label>
            <input asp-for="租期月數" type="number" min="0" class="form-control form-control-sm" id="租期月數" />
        </div>
        <div class="col-md-4">
            <label asp-for="計租週期月數" class="form-label">計租週期</label>
            <select asp-for="計租週期月數" class="form-control form-control-sm">
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i">@i</option>
                }
            </select>
        </div>

        <!-- 繳款期限 -->
        <div class="col-md-4">
            <label asp-for="繳款期限天數" class="form-label">繳款期限天數</label>
            <input asp-for="繳款期限天數" class="form-control form-control-sm" />
        </div>

        <div class="col-md-4">
            <label class="form-label">租約終止日期</label>
        <input type="text" class="form-control form-control-sm" id="租約終止日期" readonly value="@Model.租約終止日期?.ToString("yyyy/MM/dd")" />
        </div>


        <div class="col-md-12">
            <!-- 備註 -->
            <div class="form-group">
                <label asp-for="備註" class="control-label"></label>
                <textarea asp-for="備註" class="form-control" rows="3"></textarea>
            </div>
        </div>


        <div class="col-md-12">
            <!-- 送出 -->
            <div class="form-group">
                <input type="submit" value="送出" class="btn btn-primary" />
            </div>
        </div>
    </div>
</form>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script>
    $(document).ready(function () {

        //#region function:租賃用途選擇
        console.log("[頁面載入] 初始化租賃用途切換邏輯");

        const $selectDiv = $('#租賃用途-select-div');
        const $inputDiv = $('#租賃用途-input-div');
        const $select = $selectDiv.find('select');
        const $input = $inputDiv.find('input');
        const $modeRadios = $('input[name="inputMode"]');

        //#region Edit額外需要:判斷初始值是否在選單中
         const 初始租賃用途 = "@Model.租賃用途";
        const 選單選項們 = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(
        ((IEnumerable<SelectListItem>)ViewBag.租賃用途選項).Select(x => x.Value)
    ));
        
        const 是選單值 = 選單選項們.includes(初始租賃用途);// 根據初始值判斷使用 select 還是 input

        if (是選單值) {
            $('#mode-select').prop('checked', true);
            $select.val(初始租賃用途);
        } else {
            $('#mode-input').prop('checked', true);
            $input.val(初始租賃用途);
        }
        //#endregion

        function 切換輸入方式() {
            const selectedMode = $modeRadios.filter(':checked').val();

            if (selectedMode === 'select') {
                $selectDiv.show();
                $select.prop('disabled', false);      // ✅ 使能送出
                $inputDiv.hide();
                $input.prop('disabled', true);        // ❌ 避免參與表單送出
                $input.val('');
            } else {
                $selectDiv.hide();
                $select.prop('disabled', true);
                $select.val('');

                $inputDiv.show();
                $input.prop('disabled', false);
            }
        }
        //#endregion
        //#region function:計算終止日期(當起始日期或租期月數變動時)
        function 計算終止日期() {
            const startDate = $('#租約起始日期').val();
            const months = parseInt($('#租期月數').val());

            if (!startDate || isNaN(months)) {
                $('#租約終止日期').val('');
                return;
            }

            const date = new Date(startDate);
            date.setMonth(date.getMonth() + months);

            // 將 date 轉換為 yyyy/MM/dd 格式
            const y = date.getFullYear();
            const m = (date.getMonth() + 1).toString().padStart(2, '0');
            const d = date.getDate().toString().padStart(2, '0');
            $('#租約終止日期').val(`${y}/${m}/${d}`);
        }
        //#endregion


        $modeRadios.change(function () {
            切換輸入方式();
        });
        // 綁定事件
        $('#租約起始日期, #租期月數').on('change keyup', function () {
            計算終止日期();
        });
        // 初始執行
        切換輸入方式();
        計算終止日期();
        //#endregion
    });
</script>
@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}